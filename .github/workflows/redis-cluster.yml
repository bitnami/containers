name: Bitnami Redis-Cluster Docker Image CI/CD

env:
  REDIS_CONTAINER: "redis-cluster"
  REDIS_VERSION: "8.4"
  BASE_OS: "debian-12"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Build the Docker image
      run: |
        BUILD_PATH="bitnami/${REDIS_CONTAINER}/${REDIS_VERSION}/${BASE_OS}"
        LOCAL_TAG="dvs-${REDIS_CONTAINER}:${REDIS_VERSION}-${BASE_OS}"
        docker build "$BUILD_PATH" \
          --file "$BUILD_PATH/Dockerfile" \
          --tag "$LOCAL_TAG"
    - name: Push image to Azure Container Registry
      env:
        ACR_LOGIN_SERVER: ${{ secrets.ACR_REGISTRY }}
        ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
        ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
      run: |
        if [ -z "$ACR_LOGIN_SERVER" ] || [ -z "$ACR_USERNAME" ] || [ -z "$ACR_PASSWORD" ]; then
          echo "Missing ACR credentials. Please set ACR_LOGIN_SERVER, ACR_USERNAME, and ACR_PASSWORD secrets." >&2
          exit 1
        fi
        docker login "$ACR_LOGIN_SERVER" --username "$ACR_USERNAME" --password "$ACR_PASSWORD"
        REMOTE_TAG="${ACR_LOGIN_SERVER}/${REDIS_CONTAINER}:${REDIS_VERSION}-${BASE_OS}"
        LOCAL_TAG="dvs-${REDIS_CONTAINER}:${REDIS_VERSION}-${BASE_OS}"
        docker tag "$LOCAL_TAG" "$REMOTE_TAG"
        docker push "$REMOTE_TAG"
